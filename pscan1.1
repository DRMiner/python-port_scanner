#!/usr/bin/env python
import socket
import subprocess
import sys
from datetime import datetime


subprocess.call('clear')  #Ocisti Ekran
socket.setdefaulttimeout(0.5)
def skener():

    try:
        for port in range(1,1025):#(21,25,80,110,143):
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            scan=s.connect_ex((servIP,port))
            # print scan
            if scan==0:
                print "Port {}: Open".format(port)
            # else:
            #     print "Port {}: Closed".format(port)
            s.close()
    except KeyboardInterrupt:
        sys.stderr.write("\nIzlaz iz programa po zahtevu korisnika ( CTRL +C )\n")
        sys.exit(1)
    except socket.gaierror:
        sys.stderr.write('Nepoznato ime hosta!\n')
        sys.exit(2)

    except socket.error:
        sys.stderr.write("Neuspesno povezivanje sa serverom\n")
        sys.exit(3)
    t2 = datetime.now()
    vreme =  t2 - t1

    print 'Skeniranje zavrseno za: ', vreme
    s.close()
    #sys.exit()

def portskener():
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        scan= s.connect_ex((servIP,port))
        if scan==0:
            print "Port {}: Open".format(port)
        else:
             print "Port {}: Closed".format(port)
        s.close()
        t2=datetime.now()
        vreme=t2-t1
        print 'Skeniranje zavrseno za: ', vreme
        sys.exit()
    except KeyboardInterrupt:
        sys.stderr.write("\nIzlaz iz programa po zahtevu korisnika ( CTRL +C )\n")
        sys.exit(1)
    except socket.gaierror:
        sys.stderr.write('Nepoznato ime hosta!\n')
        sys.exit(2)

    except socket.error:
        sys.stderr.write("Neuspesno povezivanje sa serverom\n")
        sys.exit(3)


print "Port Scanner, opcije:\n -s : Standardno skeniranje;"
print " -p : Skeniranje specificnog porta"
print " Program se moze pokrenuti i bez argumenata, i sa predefinisanim opcijama"
print " Primer: 1) ./pscan.py 192.168.1.1 -s" # Moze se pokrenuti i samo kao ./pscan.py pa birati opcije
print "         2) ./pscan.py"                # a moze se pokrenuti i sa argumentima
print "         2) ./pscan.py localhost"
print "         2) ./pscan.py ftn.uns.ac.rs -p 80"
print " Autor: Dervisevic Rajko ET27/2016"

if len(sys.argv)>1:
    serv=sys.argv[1]
else:
    serv= raw_input("Unesite URL ili IP za skeniranje: ")
try:
    servIP = socket.gethostbyname(serv)
except socket.gaierror:
        sys.stderr.write('Nepoznato ime hosta!\n')
        sys.exit(2)

try:
    if sys.argv[2]=="-p":
        print sys.argv[2]
        print len(sys.argv)
        if len(sys.argv)!=3:
            port=int(sys.argv[3])
        else:
            port=input("Unesite koji port zelite da skenirate\n")
        print "\nSkeniranje u toku..."
        t1=datetime.now()
        portskener()
    elif sys.argv[2]=="-s":
        print "\nSkeniranje u toku..."
        t1=datetime.now()
        skener()
except IndexError:
    print "Odaberite tip skeniranja:\n"
    print "1. Skeniranje specificnog porta"
    print "2. Standardno skeniranje portova (1,1025)"
    izbor=input("1/2\n")
    if (izbor == 1):
        port=input("Unesite koji port zelite da skenirate\n")
        print "\nSkeniranje u toku..."
        t1=datetime.now()
        portskener()
    elif (izbor ==2):
        print "\nSkeniranje u toku..."
        t1=datetime.now()
        skener()
